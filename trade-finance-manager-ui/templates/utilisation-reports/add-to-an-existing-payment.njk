{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% import "./_macros/fee-record-details-table.njk" as feeRecordDetailsTable %}
{% import "./_macros/payment-group-radio-input-group.njk" as paymentGroupRadioInputGroup %}
{% extends "index.njk" %}
{% set backLinkHref = '/utilisation-reports/' + reportId %}
{% set pageHeading = "Add reported fee" + ("s" if reportedFeeDetails.feeRecords | length > 1 else "") + " to an existing payment" %}
{% block pageTitle %}
  {% if errors.errorSummary | length %}Error - {% endif %}
  {{ pageHeading }}
{% endblock %}
{% block content %}
  {{ govukBackLink({
    text: "Back",
    href: backLinkHref,
    attributes: {
      "id": "back-link",
      "data-cy": "back-link"
    }
  }) }}
  {% if errors.errorSummary | length %}
    {{ govukErrorSummary({
        titleText: "There is a problem",
        errorList: errors.errorSummary,
        attributes: {
        'data-cy': 'error-summary'
        }
    }) }}
  {% endif %}

  <div class="govuk-grid-row govuk-!-padding-top-7">
    <div class="govuk-grid-column-full">
      <span class="govuk-caption-l"  data-cy="add-to-an-existing-payment-heading-caption">{{ bank.name }},
      {{ formattedReportPeriod }}</span>
      <h1 class="govuk-heading-l">{{ pageHeading }}</h1>
    </div>
  </div>

  {{ feeRecordDetailsTable.render({
    captionText: "Selected reported fees details",
    feeRecords: reportedFeeDetails.feeRecords,
    totalReportedPayments: reportedFeeDetails.totalReportedPayments,
    enableSelectingFeeRecords: false,
    overrides: {
      reportedFeesHeader: 'Reported fee'
    }
  }) }}

  <form method="post">
    <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
    <input type="hidden" name="addToAnExistingPaymentFormSubmission" value="true"/>
    {% for id in selectedFeeRecordCheckboxIds %}<input type="hidden" name={{ id }} value="on"/>{% endfor %}

    {{ paymentGroupRadioInputGroup.render({
      legendText: availablePaymentsHeading,
      paymentGroups: availablePaymentGroups,
      errorMessage: errors.paymentGroupErrorMessage
    }) }}

    <div class="govuk-button-group">
      {{ govukButton({
        "text": "Continue",
        attributes: {
          "data-cy": "continue-button"
        }
      }) }}
      <a class="govuk-link" href="{{ backLinkHref }}" id="cancel-button" data-cy="cancel-button">Cancel</a>
    </div>
  </form>
  {# TODO FN-3293: Add integrity hash after script completed, run: shasum -b -a 512 trade-finance-manager-ui/public/js/redirectWithSelectedFeeRecords.js | awk '{ print $1 }' | xxd -r -p | base64 | awk '{print "sha512-" $1}' #}
  {# TODO FN-3293: Don't want to be sending through the full checkbox IDs (selectedFeeRecordCheckboxIds) due to length limitations, just a comma-separated string of the fee record IDs. #}
  <script
    src="/assets/js/redirectWithSelectedFeeRecords.js"
    type="text/javascript"
    crossorigin="anonymous"
    data-fee-records='{{ selectedFeeRecordCheckboxIds | dump | safe }}'
    data-target-href='{{ backLinkHref }}'></script>
{% endblock %}
{% block sub_content %}{% endblock %}