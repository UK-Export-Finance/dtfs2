version: "3"
services:
  trade_finance_manager:
    build: ./trade_finance_manager
    image: portal/tfm-ui
    ports:
      - "5100:8080"
    command: node server/index.js

  portal:
    build: ./portal
    image: dtfs/portal
    restart: always
    depends_on:
      - deal-api
    ports:
      - "5000:5000"
    volumes:
      - ./portal/scripts:/app/scripts:ro
      - ./portal/styles:/app/styles:ro
      - ./portal/templates:/app/templates:ro
      - ./portal/server:/app/server:ro
    environment:
      - DEAL_API_URL=http://deal-api:5001
      - COMPANIES_HOUSE_API_URL=https://api.companieshouse.gov.uk
      - COMPANIES_HOUSE_API_KEY
      - REFERENCE_DATA_PROXY_URL=http://reference-data-proxy:5002
    command: node dist/server.js

  deal-api:
    build: ./deal-api
    image: dtfs/deal-api
    restart: always
    depends_on:
      - deal-api-data
      - reference-data-proxy
    ports:
      - "5001:5001"
    volumes:
      - ./deal-api/src:/app/src:ro
    environment:
      - PORT=5001
      - CORS_ORIGIN=http://localhost:5000
      - JWT_SIGNING_KEY
      - JWT_VALIDATING_KEY
      - MONGO_INITDB_DATABASE=test
      - MONGODB_URI=mongodb://root:r00t@deal-api-data:27017/?authMechanism=DEFAULT
      - AZURE_WORKFLOW_STORAGE_ACCOUNT
      - AZURE_WORKFLOW_STORAGE_ACCESS_KEY
      - AZURE_WORKFLOW_FILESHARE_NAME
      - AZURE_WORKFLOW_EXPORT_FOLDER
      - AZURE_WORKFLOW_IMPORT_FOLDER
      - AZURE_PORTAL_STORAGE_ACCOUNT
      - AZURE_PORTAL_STORAGE_ACCESS_KEY
      - AZURE_PORTAL_FILESHARE_NAME
      - AZURE_PORTAL_EXPORT_FOLDER
      - DTFS_PORTAL_SCHEDULER
      - GOV_NOTIFY_API_KEY
      - GOV_NOTIFY_EMAIL_RECIPIENT
      - DTFS_PORTAL_SCHEDULER=true
      - FETCH_WORKFLOW_TYPE_B_SCHEDULE=*/1 * * * * *
      - REFERENCE_DATA_PROXY_URL=http://reference-data-proxy:5002

    entrypoint: npx nodemon src/index.js

  deal-api-data:
    image: mongo
    restart: always
    environment:
      - MONGO_INITDB_DATABASE=test
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=r00t
    volumes:
      - ./deal-api-data/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
      - ./deal-api-data-volume:/data/db
    ports:
      - "27017-27019:27017-27019"
  
  reference-data-proxy:
    build: ./reference-data-proxy
    image: dtfs/reference-data-proxy
    restart: always
    ports:
      - "5002:5002"
    volumes:
      - ./reference-data-proxy/src:/app/src:ro
    environment:
      - PORT=5002
      - MULESOFT_API
    entrypoint: npx nodemon src/index.js
    
  test-hook-api:
    build: ./test-hook-api
    image: dtfs/test-hook-api
    restart: always
    depends_on:
      - deal-api
    ports:
      - "5069:5069"
    volumes:
      - ./test-hook-api/src:/app/src:ro
    environment:
      - PORT=5069
      - CORS_ORIGIN=http://localhost:5000
      - AZURE_WORKFLOW_STORAGE_ACCOUNT
      - AZURE_WORKFLOW_STORAGE_ACCESS_KEY
      - AZURE_WORKFLOW_FILESHARE_NAME
      - AZURE_WORKFLOW_EXPORT_FOLDER
      - AZURE_WORKFLOW_IMPORT_FOLDER
      - AZURE_PORTAL_STORAGE_ACCOUNT
      - AZURE_PORTAL_STORAGE_ACCESS_KEY
      - AZURE_PORTAL_FILESHARE_NAME
      - AZURE_PORTAL_EXPORT_FOLDER
      - DTFS_PORTAL_SCHEDULER
      - GOV_NOTIFY_API_KEY
      - GOV_NOTIFY_EMAIL_RECIPIENT

    entrypoint: npx nodemon src/index.js
