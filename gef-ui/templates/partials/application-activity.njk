{%- from "moj/components/timeline/macro.njk" import mojTimeline -%}
{% import '../_macros/status-change.njk' as statusChange %}

{% extends "index.njk" %}

{% block pageTitle %}
  Application Activities
{% endblock %}

{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{{ govukPhaseBanner({
  tag: {
    text: "beta"
  },
  html: 'This is a new service â€“ your <a class="govuk-link" href="#">feedback</a> will help us to improve it.'
}) }}

{% block content %}

  {% include "includes/application-preview/summary.njk" %}
  {% include "includes/application-preview/application-sub-navigation.njk" %}

  <h1 class="govuk-heading-xl" data-cy="main-activity-heading">Activity and comments</h1>

  {% set portalActivitiesWithHTML = [] %}

  {% for activity in portalActivities %}

    {% set facilityHtml %}

      <p class="colour-light-grey" data-cy="facility-changed-by-{{activity.ukefFacilityId}}">Changed by {{activity.maker.firstname}} {{activity.maker.surname}}</p>
      <p class="colour-light-grey" data-cy="facility-checked-by-{{activity.ukefFacilityId}}">Checked by {{activity.checker.firstname}} {{activity.checker.surname}} </p>

      <p class="govuk-!-margin-bottom-0">
        <a href="/gef/application-details/{{dealId}}#{{ activity.facilityId }}" class="govuk-link" data-cy="facility-link-{{activity.ukefFacilityId}}">{{activity.facilityType}}  {{activity.ukefFacilityId}}</a>

        {{ statusChange.render({
          previousStatus: "Unissued",
          newStatus: "Issued",
          tagColour: "purple"
        }) }}
      </p>

    {% endset %}

    {% set dealCancelledHtml %}

      <p class="govuk-!-margin-bottom-0">
        <a href="/gef/application-details/{{ dealId }}" class="govuk-link" data-cy="deal-link-{{ dealId }}">Deal ID {{ ukefDealId }}</a>

        {{ statusChange.render({
          previousStatus: previousStatus,
          newStatus: "Cancelled",
          tagColour: "blue"
        }) }}
      </p>

    {% endset %}

    {% if activity.html === 'facility' %}
      {% set activityToAdd =
        {
          label: activity.label,
          text: activity.text,
          datetime: activity.datetime,
          byline: '',
          html: facilityHtml
        }
      %}

      {% elif activity.html === 'Deal cancelled' %}
        {% set activityToAdd =
          {
            label: activity.label,
            text: activity.text,
            datetime: activity.datetime,
            byline: '',
            html: dealCancelledHtml
          }
        %}
      {% else %}

      {% set activityToAdd =
        {
          label: activity.label,
          text: activity.text,
          datetime: activity.datetime,
          byline: activity.byline,
          html: activity.html
        }
      %}

    {% endif %}

    {% set portalActivitiesWithHTML = (portalActivitiesWithHTML.push(activityToAdd), portalActivitiesWithHTML) %}
  {% endfor %}

  {{ mojTimeline({
    items: portalActivitiesWithHTML,
    attributes: {
      'data-cy': 'portal-activities-timeline'
    }
  }) }}

{% endblock %}
