# This GitHub Action is designed to deploy the code bases from specified branch to an Azure WebApp

name: 'Deploy Azure WebApp'
description: 'This custom GitHub Actions module deploys from defined source to defined Azure WebApp microservice'

# Define the inputs required for this action.
inputs:
  credentials:
    description: 'Azure subscription and resource group service principal'
    required: true
  branch:
    description: 'Source Git branch, main if none specified'
    required: false
    default: 'main'
  region:
    description: 'Azure region'
    required: true
  group:
    description: 'Azure resource group'
    required: true
  acr:
    description: 'Azure container registry password'
    required: true
  webapp:
    description: 'Azure WebApp name'
    required: true

# Define the steps to run this action.
runs:
  using: 'composite'
  steps:
    # Step 1: Check out the repository.
    - name: Repository üóÉÔ∏è
      uses: actions/checkout@v5
      with:
        ref: ${{ inputs.branch }}

    # Step 2: Set up Azure CLI defaults.
    - name: Defaults ‚ú®
      uses: azure/cli@v2.1.0
      with:
        inlineScript: |
          # Basic
          az configure --defaults location=${{ inputs.region }}
          az configure --defaults group=${{ inputs.group }}

    # Step 3: Log in to Azure.
    - name: Azure üîê
      uses: azure/login@v2
      with:
        creds: ${{ inputs.credentials }}

    # Step 4: Set environment variables for ACR and WebApp.
    - name: CLI üìù
      run: |
        echo ACR=$(az acr show -n $(az resource list --resource-type 'Microsoft.ContainerRegistry/registries' --query '[0].name' -o tsv) --query loginServer -o tsv) >> $GITHUB_ENV
        echo ACR_USER=$(az acr show -n $(az resource list --resource-type 'Microsoft.ContainerRegistry/registries' --query '[0].name' -o tsv) --query name -o tsv) >> $GITHUB_ENV
        echo WEBAPP=$(az resource list --resource-type 'Microsoft.Web/sites' --query '[?contains(name, `${{ inputs.webapp }}`)].name' -o tsv) >> $GITHUB_ENV
      shell: bash

    # Step 5: Log in to Azure Container Registry.
    - name: ACR üîê
      uses: azure/docker-login@v2
      with:
        login-server: ${{ env.ACR }}
        username: ${{ env.ACR_USER }}
        password: ${{ inputs.acr }}

    # Step 6: Build and push Docker images.
    - name: Artefacts üóÉÔ∏è
      working-directory: .
      run: |
        # Build images
        docker build -f ./${{ inputs.webapp }}/Dockerfile . \
        -t ${{ env.ACR }}/${{ inputs.webapp }}:${{ github.sha }} \
        -t ${{ env.ACR }}/${{ inputs.webapp }}:latest \
        --build-arg GITHUB_SHA=${{ github.sha }}
        # Push images
        docker push ${{ env.ACR }}/${{ inputs.webapp }}:${{ github.sha }}
        docker push ${{ env.ACR }}/${{ inputs.webapp }}:latest
      shell: bash

    # Step 7: Create and swap deployment slot.
    - name: Slot üîÄ
      uses: azure/cli@v2.1.0
      with:
        inlineScript: |
          # # Create new temporary slot
          # az webapp deployment slot create \
          # --slot ${{ github.sha }} \
          # --name ${{ env.WEBAPP }} \
          # --configuration-source ${{ env.WEBAPP }} \
          # --deployment-container-image-name ${{ env.ACR }}/${{ inputs.webapp }}:latest \
          # --docker-registry-server-user ${{ env.ACR_USER }} \
          # --docker-registry-server-password ${{ inputs.acr }}
          # # Swap slot
          # az webapp deployment slot swap \
          # --slot ${{ github.sha }} \
          # --name ${{ env.WEBAPP }} \
          # --action swap
  
          SLOT=${{ github.sha }}
          WEBAPP=${{ env.WEBAPP }}
          IMAGE="${{ env.ACR }}/${{ inputs.webapp }}:latest"
          USER="${{ env.ACR_USER }}"
          PASS="${{ inputs.acr }}"

          echo "Creating slot: $SLOT"
          for i in {1..5}; do
            if az webapp deployment slot create \
              --slot $SLOT \
              --name $WEBAPP \
              --configuration-source $WEBAPP \
              --deployment-container-image-name ${{ env.ACR }}/${{ inputs.webapp }}:latest \
              --docker-registry-server-user ${{ env.ACR_USER }} \
              --docker-registry-server-password ${{ inputs.acr }}; then
              echo "Slot created successfully."
              break
            fi
            echo "Slot creation attempt $i failed, retrying..."
            sleep 45
            if [ "$i" -eq 5 ]; then
              echo "Failed to create slot after 5 attempts."
              exit 1
            fi
          done

          echo "Waiting for slot to start..."
          for i in {1..30}; do
            STATUS=$(az webapp show --name $WEBAPP --slot $SLOT --query "state" -o tsv)
            echo "Slot state: $STATUS"
            if [ "$STATUS" = "Running" ]; then break; fi
            sleep 5
            if [ "$i" -eq 30 ]; then
              echo "Slot did not start within expected time."
              exit 1
            fi
          done

          echo "Attempting slot swap..."
          for i in {1..5}; do
            if az webapp deployment slot swap \
              --slot $SLOT \
              --name $WEBAPP \
              --action swap; then
              echo "Swap succeeded."
              break
            fi
            echo "Swap attempt $i failed, retrying..."
            sleep 45
            if [ "$i" -eq 5 ]; then
              echo "Failed to swap slot after 5 attempts."
              exit 1
            fi
          done

    # Step 8: Cleanup temporary slot.
    - name: Cleanup üßπ
      if: always()
      uses: azure/cli@v2.1.0
      with:
        inlineScript: |
          # Delete temporary slot
          # az webapp deployment slot delete \
          # --slot ${{ github.sha }} \
          # --name ${{ env.WEBAPP }}

          echo "Attempting slot delete..."
          for i in {1..5}; do
            if az webapp deployment slot delete \
                --slot ${{ github.sha }} \
                --name ${{ env.WEBAPP }}; then
              echo "Swap deleted successfully."
              break
            fi
            echo "Swap delete attempt $i failed, retrying..."
            sleep 20
            if [ "$i" -eq 5 ]; then
              echo "Failed to delete slot after 5 attempts."
              exit 1
            fi
          done
