# Infrastructure Deployment Workflow
#
# This GitHub Actions workflow automates the deployment of Azure infrastructure
# for the DTFS project. It performs the following main tasks:
#
# 1. Sets up the environment and variables
# 2. Logs in to Azure
# 3. Creates or updates the resource group
# 4. Replaces placeholders in the parameters.json file with actual values from GitHub secrets
# 5. Deploys Azure resources using the Bicep template
#
# The workflow is triggered on pushes to the main branch and uses environment
# variables and secrets for configuration. It's designed to work with the
# main.bicep and parameters.json files in the infrastructure directory.
#
# Note: Ensure all required secrets and variables are set in the GitHub repository
# settings before running this workflow.

name: Infrastructure üî®
run-name: DTFS base infrastructure build from ${{ github.repository }}

on:
  push:
    branches:
      - feat/DTFS2-19579/feature-infrastructure-deployment
    paths:
      - '.github/workflows/bicep_infrastructure.yml'
      - 'infrastructure/resource_group_level/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment'
        type: environment
        required: true

env:
  PRODUCT: dtfs2
  ENVIRONMENT: feature
  TIMEZONE: '${{ vars.TIMEZONE }}'
  # Deployment environment target i.e., `development`, `staging`, `production`, `feature`
  TARGET: ${{ vars.TARGET }}

jobs:

# 1. Setup infrastructure variables
  setup:
    name: Setup üîß
    runs-on: [self-hosted, linux, deployment]
    outputs:
      environment: ${{ env.ENVIRONMENT }}
      timezone: ${{ env.TIMEZONE }}
    steps:


      - name: Repository üóÉÔ∏è
        uses: actions/checkout@v4

      - name: Environment üß™
        run: echo "Environment set to ${{ env.ENVIRONMENT }}"

      - name: Timezone üåê
        run: echo "Timezone set to ${{ env.TIMEZONE }}"

      - name: Login üîê
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_FEAT_CREDENTIALS }}

      - name: Azure defaults ‚ú®
        uses: azure/cli@v2
        with:
          inlineScript: |
            # Basic
            az configure --defaults location=${{ vars.REGION }}
            az configure --defaults group=rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}

      - name: Create Resource group üèóÔ∏è
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create \
            --location ${{ vars.REGION }} \
            --resource-group rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} \
            --name rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}

      - name: Set Resource Group Name
        run: echo "RESOURCE_GROUP_NAME=rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}" >> $GITHUB_ENV



# 2. Validate infrastructure resources
  Resource-Deploy:
    name: Deploy Resources üìä
    needs: setup
    runs-on: [self-hosted, linux, deployment]
    steps:
      - name: Repository üóÉÔ∏è
        uses: actions/checkout@v4

      - name: Login üîê
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_FEAT_CREDENTIALS }}

      - name: Replace GitHub variables into parameters.json
        run: |
          # Replace GitHub variables into parameters.json
          sed -i "s|{{ENVIRONMENT}}|${{ vars.ENVIRONMENT_FEAT }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PRODUCT}}|${{ vars.PRODUCT }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{TARGET}}|${{ vars.TARGET_FEAT }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{VERSION}}|${{ vars.VERSION || 'v1' }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PEERING_REMOTE_VNET_SUBSCRIPTION_ID}}|${{ secrets.PEERING_REMOTE_VNET_SUBSCRIPTION_ID }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_DEV_VNET_ADDRESS_PREFIX}}|${{ secrets.AZ_DEV_VNET_ADDRESS_PREFIX }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_DEV_SNET_APPGW_CIDR_PREFIX}}|${{ secrets.AZ_DEV_SNET_APPGW_CIDR_PREFIX }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_DEV_SNET_ASP_EGRESS_PREFIX_CIDR}}|${{ secrets.AZ_DEV_SNET_ASP_EGRESS_PREFIX_CIDR }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_DEV_SNET_ACA_CLAMAV_CIDR}}|${{ secrets.AZ_DEV_SNET_ACA_CLAMAV_CIDR }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_DEV_SNET_PRIVATE_EP_CIDR}}|${{ secrets.AZ_DEV_SNET_PRIVATE_EP_CIDR }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PROD_SUBNET_CIDR}}|${{ secrets.PROD_SUBNET_CIDR }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{ROUTE_TBL_NEXT_HOPE_ADDRESS}}|${{ secrets.ROUTE_TBL_NEXT_HOPE_ADDRESS }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UKEF_VPN_IPS}}|${{ secrets.UKEF_VPN_IPS }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZ_PORTAL_IPS}}|${{ secrets.AZ_PORTAL_IPS }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_TFS_KEY}}|${{ secrets.APIM_TFS_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_TFS_VALUE}}|${{ secrets.APIM_TFS_VALUE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_TFS_URL}}|${{ secrets.APIM_TFS_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_MDM_KEY}}|${{ secrets.APIM_MDM_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_MDM_URL}}|${{ secrets.APIM_MDM_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_MDM_VALUE}}|${{ secrets.APIM_MDM_VALUE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_MDM_KEY_VAULT_NAME}}|${{ secrets.APIM_MDM_KEY_VAULT_NAME }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{COMPANIES_HOUSE_API_URL}}|${{ secrets.COMPANIES_HOUSE_API_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{ORDNANCE_SURVEY_API_URL}}|${{ secrets.ORDNANCE_SURVEY_API_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{RATE_LIMIT_THRESHOLD}}|${{ secrets.RATE_LIMIT_THRESHOLD }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_ESTORE_URL}}|${{ secrets.APIM_ESTORE_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{CORS_ORIGIN}}|${{ secrets.CORS_ORIGIN }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_ESTORE_KEY}}|${{ secrets.APIM_ESTORE_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{APIM_ESTORE_VALUE}}|${{ secrets.APIM_ESTORE_VALUE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{COMPANIES_HOUSE_API_KEY}}|${{ secrets.COMPANIES_HOUSE_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{GOV_NOTIFY_EMAIL_RECIPIENT}}|${{ secrets.GOV_NOTIFY_EMAIL_RECIPIENT }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{GOV_NOTIFY_API_KEY}}|${{ secrets.GOV_NOTIFY_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{EXTERNAL_API_KEY}}|${{ secrets.EXTERNAL_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{ORDNANCE_SURVEY_API_KEY}}|${{ secrets.ORDNANCE_SURVEY_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_CREATION_FOR_BANKS_SCHEDULE}}|${{ secrets.UTILISATION_REPORT_CREATION_FOR_BANKS_SCHEDULE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{DTFS_CENTRAL_API_KEY}}|${{ secrets.DTFS_CENTRAL_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PORTAL_UI_URL}}|${{ vars.PORTAL_UI_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_DUE_DATE_BUSINESS_DAYS_FROM_START_OF_MONTH}}|${{ vars.UTILISATION_REPORT_DUE_DATE_BUSINESS_DAYS_FROM_START_OF_MONTH }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_OVERDUE_CHASER_DATE_BUSINESS_DAYS_FROM_START_OF_MONTH}}|${{ vars.UTILISATION_REPORT_OVERDUE_CHASER_DATE_BUSINESS_DAYS_FROM_START_OF_MONTH }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_REPORTING_PERIOD_START_EMAIL_SCHEDULE}}|${{ vars.UTILISATION_REPORT_REPORTING_PERIOD_START_EMAIL_SCHEDULE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_OVERDUE_EMAIL_SCHEDULE}}|${{ vars.UTILISATION_REPORT_OVERDUE_EMAIL_SCHEDULE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZURE_UTILISATION_REPORTS_FILESHARE_NAME}}|${{ vars.AZURE_UTILISATION_REPORTS_FILESHARE_NAME }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PDC_INPUTTERS_EMAIL_RECIPIENT}}|${{ secrets.PDC_INPUTTERS_EMAIL_RECIPIENT }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZURE_PORTAL_EXPORT_FOLDER}}|${{ secrets.AZURE_PORTAL_EXPORT_FOLDER }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZURE_PORTAL_FILESHARE_NAME}}|${{ secrets.AZURE_PORTAL_FILESHARE_NAME }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{JWT_VALIDATING_KEY}}|${{ secrets.JWT_VALIDATING_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{PORTAL_API_KEY}}|${{ secrets.PORTAL_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_DUE_EMAIL_SCHEDULE}}|${{ vars.UTILISATION_REPORT_DUE_EMAIL_SCHEDULE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{TFM_API_KEY}}|${{ secrets.TFM_API_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UTILISATION_REPORT_MAX_FILE_SIZE_BYTES}}|${{ vars.UTILISATION_REPORT_MAX_FILE_SIZE_BYTES }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{SESSION_SECRET}}|${{ secrets.SESSION_SECRET }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UKEF_TFM_API_SYSTEM_KEY}}|${{ secrets.UKEF_TFM_API_SYSTEM_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{ESTORE_URL}}|${{ secrets.ESTORE_URL }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UKEF_TFM_API_REPORTS_KEY}}|${{ secrets.UKEF_TFM_API_REPORTS_KEY }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE}}|${{ secrets.AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE }}|g" ./infrastructure/resource_group_level/parameters_dev.json
          sed -i "s|{{UKEF_INTERNAL_NOTIFICATION}}|${{ secrets.UKEF_INTERNAL_NOTIFICATION }}|g" ./infrastructure/resource_group_level/parameters_dev.json


      - name: Install Bicep
        run: |
          az config set bicep.use_binary_from_path=False
          az bicep install
          az bicep upgrade
          az bicep version

      - name: Deploy Azure Resources
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_FEAT_SUBSCRIPTION_ID }}
          resourceGroupName: rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}
          template: ./infrastructure/resource_group_level/main.bicep
          parameters: ./infrastructure/resource_group_level/parameters_dev.json
          scope: resourcegroup

