name: Production DNS

on:
  push:
    branches: [ infrastructure ]
    paths: 
    - '.github/workflows/dns.yml'

env:
  credentials: ${{ secrets.AZURE_DIGITAL_PROD }}
  resource_group: ${{ secrets.PROD_RESOURCE_GROUP }}

jobs:

  zone:
    name: Create service.gov.uk zone
    runs-on: ubuntu-latest
    steps:

    - uses: azure/login@v1
      with:
        creds: ${{ env.credentials }}

    - name: Defaults
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az configure --defaults location=uksouth
          az configure --defaults group=${{ env.resource_group }}

          # Front door requires an extension to the az cli:
          az extension add --name front-door

    - name: Zone
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az network dns zone create --name get-guarantee-for-export-finance.service.gov.uk

    - name: Front Door verification record
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az network dns record-set cname create --zone get-guarantee-for-export-finance.service.gov.uk --name afdverify.tfs-prod-fd.azurefd.net
          az network dns record-set cname set-record --zone get-guarantee-for-export-finance.service.gov.uk --record-set-name afdverify.tfs-prod-fd.azurefd.net --cname tfs-prod-fb.azurefd.net

    - name: Check domain name mapping
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az network front-door check-custom-domain --host-name get-guarantee-for-export-finance.service.gov.uk --name tfs-prod-fd -g Digital-prod