name: Deploy via Bicep

on:
  workflow_call:
    inputs:
      environment:
        description: What environment is being deployed
        required: true
        type: string
      runWhatIf:
        description: Run a What-If deploy rather than just a pre-flight check
        required: false
        type: boolean
        default: false
      resourceGroupName:
        required: true
        type: string
      # TODO:FN-72 I don't think vars need passing in - check
      # RATE_LIMIT_THRESHOLD:
      #   required: true
      #   type: string
    secrets:
      AZURE_CREDENTIALS:
        required: true
      REMOTE_VNET_SUBSCRIPTION_VPN:
        description: Subscription Id to set up vnet peering for
        required: true
      REMOTE_VNET_RESOURCE_GROUP_VPN:
        description: Resource group the remote vnet resides in that we want to set up peering for
        required: true
      REMOTE_VNET_NAME_VPN:
        description: Name of the remote vnet we want to set up peering for
        required: true
      REMOTE_VNET_PEERING_ADDRESS_SPACE:
        description: Remote VNet Peering address space
        required: true
      onPremiseNetworkIpsString:
        description: Ps allowed to access restricted services, represented as Json array string
        required: true
      APIM_TFS_KEY:
        description: webapp environment variable
        required: true
      APIM_TFS_VALUE:
        description: webapp environment variable
        required: true
      APIM_TFS_URL:
        description: webapp environment variable
        required: true
      APIM_MDM_KEY:
        description: webapp environment variable
        required: true
      APIM_MDM_URL:
        description: webapp environment variable
        required: true
      APIM_MDM_VALUE:
        description: webapp environment variable
        required: true
      DOCKER_REGISTRY_SERVER_PASSWORD:
        description: webapp environment variable
        required: true
      MACHINEKEY_DecryptionKey:
        description: webapp environment variable
        required: true
      CORS_ORIGIN:
        description: webapp environment variable
        required: true
      APIM_ESTORE_URL:
        description: webapp environment variable
        required: true
      APIM_ESTORE_KEY:
        description: webapp environment variable
        required: true
      APIM_ESTORE_VALUE:
        description: webapp environment variable
        required: true
      COMPANIES_HOUSE_API_KEY:
        description: webapp environment variable
        required: true
      ORDNANCE_SURVEY_API_KEY:
        description: webapp environment variable
        required: true
      GOV_NOTIFY_API_KEY:
        description: webapp environment variable
        required: true
      GOV_NOTIFY_EMAIL_RECIPIENT:
        description: webapp environment variable
        required: true
      AZURE_PORTAL_EXPORT_FOLDER:
        description: webapp environment variable
        required: true
      AZURE_PORTAL_FILESHARE_NAME:
        description: webapp environment variable
        required: true
      JWT_SIGNING_KEY:
        description: webapp environment variable
        required: true
      JWT_VALIDATING_KEY:
        description: webapp environment variable
        required: true
      UKEF_INTERNAL_NOTIFICATION:
        description: webapp environment variable
        required: true
      DTFS_CENTRAL_API_KEY:
        description: webapp environment variable
        required: true
      EXTERNAL_API_KEY:
        description: webapp environment variable
        required: true
      PORTAL_API_KEY:
        description: webapp environment variable
        required: true
      TFM_API_KEY:
        description: webapp environment variable
        required: true
      UKEF_TFM_API_SYSTEM_KEY:
        description: webapp environment variable
        required: true
      UKEF_TFM_API_REPORTS_KEY:
        description: webapp environment variable
        required: true
      TFM_UI_URL:
        description: webapp environment variable
        required: true
      AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE:
        description: webapp environment variable
        required: true
      SESSION_SECRET:
        description: webapp environment variable
        required: true
      ESTORE_URL:
        description: webapp environment variable
        required: true
      
jobs:
  validate:
    runs-on: [self-hosted, linux, deployment]
    # TODO: FN-72 NOTE: we don't currently have a `feature` GitHub environment yet so use the `dev` one while we're not doing much 
    # environment: ${{ inputs.environment }}
    environment: dev

    steps:
    - uses: actions/checkout@v3

    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create ASP as a test
      run: |
        az configure --defaults location=uksouth
        az configure --defaults group=${{ inputs.resourceGroupName }}
        az appservice plan create --name feature-asp --is-linux --sku p2v2

    - if: ${{ inputs.runWhatIf == false }}
      uses: azure/arm-deploy@v1
      name: Run pre-flight check
      with:
        deploymentName: ${{ github.run_number }}
        resourceGroupName: ${{ inputs.resourceGroupName }}
        template: ./infrastructure/resource_group_level/main.bicep
        deploymentMode: Validate
        parameters: >
          environment=${{ inputs.environment }}
          peeringRemoteVnetSubscriptionId=${{ secrets.REMOTE_VNET_SUBSCRIPTION_VPN }}
          peeringRemoteVnetResourceGroupName=${{ secrets.REMOTE_VNET_RESOURCE_GROUP_VPN}}
          peeringRemoteVnetName=${{ secrets.REMOTE_VNET_NAME_VPN }}
          peeringAddressSpace=${{ secrets.REMOTE_VNET_PEERING_ADDRESS_SPACE }}
          onPremiseNetworkIpsString=${{ secrets.onPremiseNetworkIpsString }}

          APIM_TFS_KEY: ${{ secrets.APIM_TFS_KEY }}
          APIM_TFS_VALUE: ${{ secrets.APIM_TFS_VALUE }}
          APIM_TFS_URL: ${{ secrets.APIM_TFS_URL }}
          APIM_MDM_KEY: ${{ secrets.APIM_MDM_KEY }}
          APIM_MDM_URL: ${{ secrets.APIM_MDM_URL }}
          APIM_MDM_VALUE: ${{ secrets.APIM_MDM_VALUE }}
          DOCKER_REGISTRY_SERVER_PASSWORD: ${{ secrets.DOCKER_REGISTRY_SERVER_PASSWORD }}
          MACHINEKEY_DecryptionKey: ${{ secrets.MACHINEKEY_DecryptionKey }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
          APIM_ESTORE_URL: ${{ secrets.APIM_ESTORE_URL }}
          APIM_ESTORE_KEY: ${{ secrets.APIM_ESTORE_KEY }}
          APIM_ESTORE_VALUE: ${{ secrets.APIM_ESTORE_VALUE }}
          COMPANIES_HOUSE_API_KEY: ${{ secrets.COMPANIES_HOUSE_API_KEY }}
          ORDNANCE_SURVEY_API_KEY: ${{ secrets.ORDNANCE_SURVEY_API_KEY }}
          GOV_NOTIFY_API_KEY: ${{ secrets.GOV_NOTIFY_API_KEY }}
          GOV_NOTIFY_EMAIL_RECIPIENT: ${{ secrets.GOV_NOTIFY_EMAIL_RECIPIENT }}
          AZURE_PORTAL_EXPORT_FOLDER: ${{ secrets.AZURE_PORTAL_EXPORT_FOLDER }}
          AZURE_PORTAL_FILESHARE_NAME: ${{ secrets.AZURE_PORTAL_FILESHARE_NAME }}
          JWT_SIGNING_KEY: ${{ secrets.JWT_SIGNING_KEY }}
          JWT_VALIDATING_KEY: ${{ secrets.JWT_VALIDATING_KEY }}
          UKEF_INTERNAL_NOTIFICATION: ${{ secrets.UKEF_INTERNAL_NOTIFICATION }}
          DTFS_CENTRAL_API_KEY: ${{ secrets.DTFS_CENTRAL_API_KEY }}
          EXTERNAL_API_KEY: ${{ secrets.EXTERNAL_API_KEY }}
          PORTAL_API_KEY: ${{ secrets.PORTAL_API_KEY }}
          TFM_API_KEY: ${{ secrets.TFM_API_KEY }}
          UKEF_TFM_API_SYSTEM_KEY: ${{ secrets.UKEF_TFM_API_SYSTEM_KEY }}
          UKEF_TFM_API_REPORTS_KEY: ${{ secrets.UKEF_TFM_API_REPORTS_KEY }}
          TFM_UI_URL: ${{ secrets.TFM_UI_URL }}
          AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE: ${{ secrets.AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          ESTORE_URL: ${{ secrets.ESTORE_URL }}
          
          RATE_LIMIT_THRESHOLD: ${{ vars.RATE_LIMIT_THRESHOLD}}

    - if: ${{ inputs.runWhatIf == true }}
      uses: azure/arm-deploy@v1
      name: Run what-if
      with:
        failOnStdErr: false
        resourceGroupName: ${{ inputs.resourceGroupName }}
        template: ./infrastructure/resource_group_level/main.bicep
        additionalArguments: --what-if
        parameters: >
          environment=${{ inputs.environment }}
          peeringRemoteVnetSubscriptionId=${{ secrets.REMOTE_VNET_SUBSCRIPTION_VPN }}
          peeringRemoteVnetResourceGroupName=${{ secrets.REMOTE_VNET_RESOURCE_GROUP_VPN}}
          peeringRemoteVnetName=${{ secrets.REMOTE_VNET_NAME_VPN }}
          peeringAddressSpace=${{ secrets.REMOTE_VNET_PEERING_ADDRESS_SPACE }}
          onPremiseNetworkIpsString=${{ secrets.onPremiseNetworkIpsString }}

          APIM_TFS_KEY: ${{ secrets.APIM_TFS_KEY }}
          APIM_TFS_VALUE: ${{ secrets.APIM_TFS_VALUE }}
          APIM_TFS_URL: ${{ secrets.APIM_TFS_URL }}
          APIM_MDM_KEY: ${{ secrets.APIM_MDM_KEY }}
          APIM_MDM_URL: ${{ secrets.APIM_MDM_URL }}
          APIM_MDM_VALUE: ${{ secrets.APIM_MDM_VALUE }}
          DOCKER_REGISTRY_SERVER_PASSWORD: ${{ secrets.DOCKER_REGISTRY_SERVER_PASSWORD }}
          MACHINEKEY_DecryptionKey: ${{ secrets.MACHINEKEY_DecryptionKey }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
          APIM_ESTORE_URL: ${{ secrets.APIM_ESTORE_URL }}
          APIM_ESTORE_KEY: ${{ secrets.APIM_ESTORE_KEY }}
          APIM_ESTORE_VALUE: ${{ secrets.APIM_ESTORE_VALUE }}
          COMPANIES_HOUSE_API_KEY: ${{ secrets.COMPANIES_HOUSE_API_KEY }}
          ORDNANCE_SURVEY_API_KEY: ${{ secrets.ORDNANCE_SURVEY_API_KEY }}
          GOV_NOTIFY_API_KEY: ${{ secrets.GOV_NOTIFY_API_KEY }}
          GOV_NOTIFY_EMAIL_RECIPIENT: ${{ secrets.GOV_NOTIFY_EMAIL_RECIPIENT }}
          AZURE_PORTAL_EXPORT_FOLDER: ${{ secrets.AZURE_PORTAL_EXPORT_FOLDER }}
          AZURE_PORTAL_FILESHARE_NAME: ${{ secrets.AZURE_PORTAL_FILESHARE_NAME }}
          JWT_SIGNING_KEY: ${{ secrets.JWT_SIGNING_KEY }}
          JWT_VALIDATING_KEY: ${{ secrets.JWT_VALIDATING_KEY }}
          UKEF_INTERNAL_NOTIFICATION: ${{ secrets.UKEF_INTERNAL_NOTIFICATION }}
          DTFS_CENTRAL_API_KEY: ${{ secrets.DTFS_CENTRAL_API_KEY }}
          EXTERNAL_API_KEY: ${{ secrets.EXTERNAL_API_KEY }}
          PORTAL_API_KEY: ${{ secrets.PORTAL_API_KEY }}
          TFM_API_KEY: ${{ secrets.TFM_API_KEY }}
          UKEF_TFM_API_SYSTEM_KEY: ${{ secrets.UKEF_TFM_API_SYSTEM_KEY }}
          UKEF_TFM_API_REPORTS_KEY: ${{ secrets.UKEF_TFM_API_REPORTS_KEY }}
          TFM_UI_URL: ${{ secrets.TFM_UI_URL }}
          AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE: ${{ secrets.AZURE_NUMBER_GENERATOR_FUNCTION_SCHEDULE }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          ESTORE_URL: ${{ secrets.ESTORE_URL }}
          
          RATE_LIMIT_THRESHOLD: ${{ vars.RATE_LIMIT_THRESHOLD}}