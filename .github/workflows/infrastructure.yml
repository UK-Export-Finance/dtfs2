name: Infrastructure

on:
  push:
    branches: [ infrastructure ]
  schedule:
    # A weekly run to roll up any base image patches,
    # in office hours, avoiding bank holiday Mondays:
    # "At 12:00 on Tuesday." - https://crontab.guru/
    - cron: '0 12 * * 2'
    
env:
  TAG: latest

  COMPANIES_HOUSE_API_KEY: ${{ secrets.COMPANIES_HOUSE_API_KEY }}

  AZURE_WORKFLOW_STORAGE_ACCOUNT: ${{ secrets.AZURE_WORKFLOW_STORAGE_ACCOUNT }}
  AZURE_WORKFLOW_STORAGE_ACCESS_KEY: ${{ secrets.AZURE_WORKFLOW_STORAGE_ACCESS_KEY }}
  AZURE_WORKFLOW_FILESHARE_NAME: ${{ secrets.AZURE_WORKFLOW_FILESHARE_NAME }}
  AZURE_WORKFLOW_EXPORT_FOLDER: ${{ secrets.AZURE_WORKFLOW_EXPORT_FOLDER }}
  AZURE_WORKFLOW_IMPORT_FOLDER: ${{ secrets.AZURE_WORKFLOW_IMPORT_FOLDER }}

  AZURE_PORTAL_STORAGE_ACCOUNT: ${{ secrets.AZURE_PORTAL_STORAGE_ACCOUNT }}
  AZURE_PORTAL_STORAGE_ACCESS_KEY: ${{ secrets.AZURE_PORTAL_STORAGE_ACCESS_KEY }}
  AZURE_PORTAL_FILESHARE_NAME: ${{ secrets.AZURE_PORTAL_FILESHARE_NAME }}
  AZURE_PORTAL_EXPORT_FOLDER: ${{ secrets.AZURE_PORTAL_EXPORT_FOLDER }}

jobs:

  dev:
    name: Dev environment
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: dev
      TAG: latest
    steps:
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_DIGITAL_DEV }}

    - name: Portal UI
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az webapp create --name tfs-portal-ui-${{ env.ENVIRONMENT }} \
            --resource-group ${{ secrets.RESOURCE_GROUP_DEV }} \
            --plan ${{ env.ENVIRONMENT }} \
            --deployment-container-image-name ${{ secrets.ACR_DEV_REGISTRY }}/deal-api:${{ env.TAG }}
          az webapp config connection-string set --name tfs-portal-ui-${{ env.ENVIRONMENT }} \
            --resource-group ${{ secrets.RESOURCE_GROUP_DEV }} \
            --connection-string-type custom
            --settings COMPANIES_HOUSE_API_KEY=${{ secrets.COMPANIES_HOUSE_API_KEY }}

    - name: Portal API
      uses: Azure/cli@v1.0.0
      with:
        inlineScript: |
          az webapp create --name tfs-portal-api-${{ env.ENVIRONMENT }} \
              --resource-group ${{ secrets.RESOURCE_GROUP_DEV }} \
              --plan ${{ env.ENVIRONMENT }} \
              --deployment-container-image-name ${{ secrets.ACR_DEV_REGISTRY }}/deal-api:${{ env.TAG }}
