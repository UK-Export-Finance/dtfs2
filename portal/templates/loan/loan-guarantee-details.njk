{% extends "index.njk" %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% import './_macros/loan-nav.njk' as loanNav %}
{% import '_macros/date-field.njk' as dateField %}

{% block pageTitle %}Loan Guarantee Details{% endblock %}

{% block content %}

  {% set showConditionalFormFieldsByDefault = loan.facilityStage === "Conditional" %}
  {% set showUnconditionalFormFieldsByDefault = loan.facilityStage === "Unconditional" %}

  <script type="text/javascript">
    function toggleFormFields(facilityStage) {
      var conditionalFormFields = document.getElementById('conditional-form-fields');
      var unconditionalFormFields = document.getElementById('unconditional-form-fields');
      if (facilityStage === 'conditional') {
        conditionalFormFields.className = '';
        unconditionalFormFields.className = 'govuk-visually-hidden';
      }
      if (facilityStage === 'unconditional') {
        unconditionalFormFields.className = '';
        conditionalFormFields.className = 'govuk-visually-hidden';
      }
    }
  </script>

  {% if validationErrors.count %}
    {{
      govukErrorSummary({
        titleText: "There is a problem",
        errorList: validationErrors.summary
      })
    }}
  {% endif %}

  {{ loanNav.render(
    completedStatus = loan.completedStatus,
    current = 'loanDetails',
    contractId = dealId,
    childId = loan._id
  )}}

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-8" />

  <form method="POST" autocomplete="off" novalidate>

    <div class="govuk-grid-row">

      <div class="govuk-grid-column-three-quarters">

        <div class="govuk-character-count" data-module="govuk-character-count" data-maxlength="30">
          {{ govukInput({
            label: {
              text: "Bank reference number (optional)"
            },
            id: "bankReferenceNumber",
            name: "bankReferenceNumber",
            value: loan.bankReferenceNumber,
            classes: 'govuk-input--width-20 govuk-js-character-count',
            attributes: {
              maxlength: '30',
              'aria-describedby': 'bank-reference-number-info',
              'data-cy': 'bank-reference-number'
            },
            errorMessage: validationErrors.errorList.bankReferenceNumber and {
              text: validationErrors.errorList.bankReferenceNumber.text,
              attributes: {
                'data-cy': 'bank-reference-number-error-message'
              }
            }
          }) }} 
          <span id="bankReferenceNumber-info" class="govuk-hint govuk-character-count__message" aria-live="polite">
            You can enter up to 30 characters
          </span>
        </div>
 

        {{ govukRadios({
          classes: "govuk-radios--inline",
          idPrefix: "facilityStage",
          name: "facilityStage",
          fieldset: {
            legend: {
              text: "Facility stage"
            }
          },
          hint: {
            text: "Conditional where Conditions Precedent are not yet satisfied (uncommitted) or unconditional when Conditions Precedent are satisfied (committed)."
          },
          items: [
            {
              value: "Conditional",
              text: "Conditional",
              checked: loan.facilityStage === "Conditional",
              attributes: {
                'data-cy': "loan-stage-conditional",
                onClick: "toggleFormFields('conditional')"
              }
            },
            {
              value: "Unconditional",
              text: "Unconditional",
              checked: loan.facilityStage === "Unconditional",
              attributes: {
                'data-cy': "loan-stage-unconditional",
                onClick: "toggleFormFields('unconditional')"
              }
            }
          ],
          errorMessage: validationErrors.errorList.facilityStage and {
            text: validationErrors.errorList.facilityStage.text,
            attributes: {
              'data-cy': 'facility-stage-error-message'
            }
          }
        }) }}

        <div
          id="conditional-form-fields"
          {% if showConditionalFormFieldsByDefault === false %}
          class="govuk-visually-hidden"
          {% endif %}
        >

          {{ govukInput({
            inputmode: 'numeric',
            label: {
              text: "Length of time that the UKEF's guarantee will be in place for (in months, rounded up)"
            },
            classes: "govuk-input--width-5",
            id: "ukefGuaranteeInMonths",
            name: "ukefGuaranteeInMonths",
            value: loan.ukefGuaranteeInMonths,
            attributes: {
              'data-cy': 'ukef-guarantee-in-months',
              maxlength: '2'
            },
            errorMessage: (validationErrors.errorList.ukefGuaranteeInMonths.text or (not loan.ukefGuaranteeInMonths and validationErrors.conditionalErrorList.facilityStage.Conditional.ukefGuaranteeInMonths.text)) and {
              text: validationErrors.errorList.ukefGuaranteeInMonths.text or (not loan.ukefGuaranteeInMonths and validationErrors.conditionalErrorList.facilityStage.Conditional.ukefGuaranteeInMonths.text),
              attributes: {
                'data-cy': 'ukef-guarantee-in-months-error-message'
              }
            }
          }) }}

        </div>

        <div
          id="unconditional-form-fields"
          {% if showUnconditionalFormFieldsByDefault === false %}
          class="govuk-visually-hidden"
          {% endif %}
        >

          <div class="govuk-form-group">
            {{ dateField.render(
              legend = 'Requested Cover Start Date (optional)',
              id = 'requestedCoverStartDate',
              hint = '<p>For example, 31 05 2017</p><p>This must be within the next month. If this field is left blank it will default to the later of the Issued date or Inclusion Notice submission date.</p>',
              dayValue = loan['requestedCoverStartDate-day'],
              monthValue = loan['requestedCoverStartDate-month'],
              yearValue = loan['requestedCoverStartDate-year'],
              error = validationErrors.errorList.requestedCoverStartDate
            )}}
          </div>

          <div class="govuk-form-group">
            {{ dateField.render(
              legend = 'Cover End Date',
              id = 'coverEndDate',
              hint = 'For example, 31 05 2017',
              dayValue = loan['coverEndDate-day'],
              monthValue = loan['coverEndDate-month'],
              yearValue = loan['coverEndDate-year'],
              error = validationErrors.errorList.coverEndDate,
              conditionalError = validationErrors.conditionalErrorList.facilityStage.Unconditional.coverEndDate
            )}}
          </div>

        </div>

        <button type="submit" class="govuk-button govuk-!-margin-right-1" data-module="govuk-button">Next page</button>

        <input
          type="submit"
          formaction="/contract/{{ dealId }}/loan/{{ loan._id }}/save-go-back"
          class="govuk-button govuk-button--secondary"
          data-module="govuk-button"
          value="Save and go back to deal"
          data-cy="save-go-back-button"
        />

      </div>
    </div>

  </form>

{% endblock %}
