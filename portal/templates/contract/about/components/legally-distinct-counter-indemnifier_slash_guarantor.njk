{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
{% import './address-fields.njk' as address %}
{% import './input-companies-house-reg-number.njk' as companiesHouse %}
{% import './indemnifier-correspondence-address.njk' as indemnifierCorrespondenceAddress %}

{% macro render(opts) %}
  {% set deal = opts.deal %}
  {% set countries = opts.mappedCountries %}
  {% set validationErrors = opts.validationErrors %}

  {{
    govukRadios({
      fieldset: {
        legend: { text: "Is the counter-indemnifier (for bonds) or guarantor (for loans) legally distinct from the supplier?" }
      },
      idPrefix: "legallyDistinct-",
      name: "legallyDistinct",
      classes: "govuk-radios--inline",
      items: [
        {
          value: "true",
          text: "Yes",
          attributes: {
            "data-cy": "legallyDistinct-true"
          },
          checked: deal.submissionDetails.legallyDistinct === 'true'
        },
        {
          value: "false",
          text: "No",
          attributes: {
            "data-cy": "legallyDistinct-false"
          },
          checked: deal.submissionDetails.legallyDistinct === 'false'
        }
      ],
      errorMessage: validationErrors.errorList.legallyDistinct
    })
  }}

  {% set renderByDefault=deal.submissionDetails.legallyDistinct %}

  {% if renderByDefault !== 'true' %}
    {% set renderByDefault = 'false' %}
  {% endif %}

  <div id="additional-form-fields-indemnifier" class="{% if renderByDefault === 'false' %}display-none{% endif %}">

    {{ companiesHouse.input({
      label: 'Indemnifier Companies House registration number (optional)',
      deal: deal,
      prefix: 'indemnifier',
      validationErrors: validationErrors
    }) }}

    {# TODO - the component has "you have X characters remaining" at the bottom. Do we really need the hint as well? #}

    {{ govukCharacterCount({
      name: "indemnifier-name",
      id: "indemnifier-name",
      value: deal.submissionDetails["indemnifier-name"],
      maxlength: 150,
      classes: "govuk-!-width-one-half",
      label: {
        text: "Indemnifier name"
      },
      hint: {
        text: "You can enter up to 150 characters"
      },
      errorMessage: validationErrors and {
        text: validationErrors.errorList["indemnifier-name"].text
      },
      attributes: {
        "data-cy": "indemnifier-name"
      }
    }) }}

    {{ address.fields(
      deal = deal,
      validationErrors = validationErrors,
      id = "indemnifier-address",
      legend = "Indemnifier address",
      countries = countries,
      showCountryPleaseSelect = true
    )}}

    {{ indemnifierCorrespondenceAddress.render({
      deal: deal,
      countries: countries,
      validationErrors: validationErrors
    }) }}

  </div>

{% endmacro %}
