{% import '_macros/status-tag.njk' as statusTag %}
{% import './bond-link.njk' as bondLink %}

{# TODO: component tests #}

{% macro render(params) %}
  {% if params.deal.bondTransactions.items %}
    <div class="govuk-grid-column-full">
      {% set bonds = params.deal.bondTransactions.items %}
      {% set dealId = params.deal._id %}
      {% set dealStatus = params.deal.details.status %}
      {% set dealSubmissionType = params.deal.details.submissionType %}
      {% set userIsMaker = params.user.roles.includes('maker')%}
      {% set userIsChecker = params.user.roles.includes('checker')%}

        <table class="govuk-table contract-table contract-transactions-table govuk-!-margin-bottom-0">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Bond's unique number</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">UKEF facility ID</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Status</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Value</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Stage</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Start date</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">End date</th>
              <th scope="col" class="govuk-table__header govuk-!-font-size-14">Action</th>
            </tr>
          </thead>

          <tbody class="govuk-table__body">

            {% for bond in bonds %}
              <tr class="govuk-table__row" data-cy="bond-{{ bond._id }}">
                <td class="govuk-table__cell govuk-!-font-size-14">
                  {{ bondLink.render(params, bond) }}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14">
                  {{ bond.ukefFacilityID }}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14 contract-table--status-cell" data-cy="bond-status-{{ bond._id}}">
                  {{ statusTag.render(bond.status) }}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14" data-cy="bond-facility-value">
                  {{ bond.currency.id}} {{ bond.facilityValue }}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14" data-cy="bond-stage">
                  {{ bond.bondStage }}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14" data-cy="bond-requested-cover-start-date">
                  {% if bond.requestedCoverStartDate %}
                  {{ bond.requestedCoverStartDate | localiseTimestamp('DD/MM/YYYY', params.user.timezone) }}
                {% endif %}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14" data-cy="bond-cover-end-date">
                  {% if bond['coverEndDate-day'] and bond['coverEndDate-month'] and bond['coverEndDate-year'] %}
                    {{ bond['coverEndDate-day'] }}/{{ bond['coverEndDate-month'] }}/{{ bond['coverEndDate-year'] }}
                  {% endif %}
                </td>

                <td class="govuk-table__cell govuk-!-font-size-14">

                  {% set canIssueFacility = userIsMaker and (dealSubmissionType === 'Automatic Inclusion Notice' or dealSubmissionType === 'Manual Inclusion Notice') and bond.bondStage === 'Unissued' and not bond.issueFacilityDetailsProvided and not bond.issueFacilityDetailsSubmitted %}

                  {% if dealStatus === "Acknowledged by UKEF" or dealStatus === "Ready for Checker's approval" %}

                    {% if canIssueFacility %}
                      <a href="/contract/{{ dealId }}/bond/{{ bond._id}}/issue-facility" class="govuk-link" data-cy="bond-issue-facility-{{ bond._id }}">Issue facility</a>
                    {% endif %}

                    {% if bond.issueFacilityDetailsProvided %}
                      
                      {% if userIsChecker %}
                        <a href="/contract/{{ dealId }}/submission-details#bond-{{ bond._id }}" class="govuk-link" data-cy="bond-issue-facility-{{ bond._id }}">Facility issued</a>
                      {% else %}

                        {% if bond.issueFacilityDetailsSubmitted %}
                          <a href="/contract/{{ dealId }}/bond/{{ bond._id}}/preview" class="govuk-link" data-cy="bond-issue-facility-{{ bond._id }}">Facility issued</a>
                        {% else %}
                          <a href="/contract/{{ dealId }}/bond/{{ bond._id}}/issue-facility" class="govuk-link" data-cy="bond-issue-facility-{{ bond._id }}">Facility issued</a>
                        {% endif %}

                      {% endif %}

                    {% endif %}

                  {% else %}
                  {% if params.editable %}
                    <a href="/contract/{{ dealId }}/bond/{{ bond._id}}/delete" class="govuk-link" data-cy="bond-delete-{{ bond._id }}" aria-label="Delete bond">Delete</a>
                  {% endif %}

                {% endif %}
                
                </td>
              </tr>

            {% endfor %}
          </tbody>
        </table>
    </div>
  {% endif %}
{% endmacro %}
