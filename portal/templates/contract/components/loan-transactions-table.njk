{% import '_macros/status-tag.njk' as statusTag %}
{% import './loan-link.njk' as loanLink %}

{# TODO: component tests #}

{% macro render(params) %}
  {% if params.deal.loanTransactions.items %}
    <div class="govuk-grid-column-full">
      {% set loans = params.deal.loanTransactions.items %}
      {% set dealId = params.deal._id %}
      {% set dealStatus = params.deal.details.status %}
      {% set userIsMaker = params.user.roles.includes('maker')%}

      <table class="govuk-table contract-table govuk-!-margin-bottom-0">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Bank reference number</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">UKEF facility ID</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Status</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Value</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Stage</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Start date</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">End date</th>
            <th scope="col" class="govuk-table__header govuk-!-font-size-14">Action</th>
          </tr>
        </thead>

        <tbody class="govuk-table__body">

          {% for loan in loans %}
            <tr class="govuk-table__row" data-cy="loan-{{ loan._id }}">
              <td class="govuk-table__cell govuk-!-font-size-14">
                {{ loanLink.render(params, loan) }}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14">
                {{ loan.ukefFacilityID }}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14 contract-table--status-cell" data-cy="loan-status">
                {{ statusTag.render(loan.status) }}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14" data-cy="loan-facility-value">
                {{ loan.currency.id}} {{ loan.facilityValue }}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14" data-cy="loan-facility-stage">
                {{ loan.facilityStage }}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14" data-cy="loan-requested-cover-start-date">
                {% if loan['requestedCoverStartDate-day'] and loan['requestedCoverStartDate-month'] and loan['requestedCoverStartDate-year'] %}
                  {{ loan['requestedCoverStartDate-day'] }}/{{ loan['requestedCoverStartDate-month'] }}/{{ loan['requestedCoverStartDate-year'] }}
                {% endif %}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14" data-cy="loan-cover-end-date">
                {% if loan['coverEndDate-day'] and loan['coverEndDate-month'] and loan['coverEndDate-year'] %}
                  {{ loan['coverEndDate-day'] }}/{{ loan['coverEndDate-month'] }}/{{ loan['coverEndDate-year'] }}
                {% endif %}
              </td>

              <td class="govuk-table__cell govuk-!-font-size-14">

                {% set canIssueFacility = userIsMaker and dealStatus === 'Acknowledged by UKEF' and loan.facilityStage === 'Conditional' and not loan.facilityIssued %}

                {% if canIssueFacility %}
                  <a href="/contract/{{ dealId }}/loan/{{ loan._id}}/issue-facility" class="govuk-link" data-cy="issue-facility-loan-{{ loan._id }}">Issue facility</a>
                {% endif %}

                {% if params.editable and not canIssueFacility %}
                  <a href="/contract/{{ dealId }}/loan/{{ loan._id}}/delete" class="govuk-link" data-cy="delete-loan-{{ loan._id }}">Delete</a>
                {% endif %}

                {% if loan.facilityIssued %}
                  <a href="/contract/{{ dealId }}/loan/{{ loan._id}}/issue-facility" class="govuk-link" data-cy="issue-facility-loan-{{ loan._id }}">Facility issued</a>
                {% endif %}

              </td>
            </tr>

          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

{% endmacro %}
