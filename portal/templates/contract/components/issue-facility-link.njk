{# TODO: refactor #}
{% macro render(params) %}

  {% set userIsMaker = params.user.roles.includes('maker')%}
  {% set userIsChecker = params.user.roles.includes('checker')%}

  {% set dealId = params.deal._id %}
  {% set dealStatus = params.deal.details.status %}
  {% set dealSubmissionType = params.deal.details.submissionType %}
  {% set dealPreviousStatus = params.deal.details.previousStatus %}

  {% set facility = params.facility %}
  {% set facilityName = params.facilityName %}

  {% set dealStatusAllowsIssueFacility = dealStatus === "Acknowledged by UKEF" or dealStatus === "Accepted by UKEF (with conditions)" or dealStatus === "Accepted by UKEF (without conditions)" or dealStatus === "Ready for Checker's approval" or dealStatus === "Further Maker's input required" and dealPreviousStatus !== "Draft"%}

  {% set facilityCouldBeIssued = userIsMaker and (dealSubmissionType === 'Automatic Inclusion Notice' or dealSubmissionType === 'Manual Inclusion Notice' or dealSubmissionType === 'Manual Inclusion Application') and (facility.facilityStage === 'Conditional' or facility.bondStage === 'Unissued') and not facility.issueFacilityDetailsSubmitted %}

  {% set dealOrFacilityAreReadyForCheck = (facility.status === "Ready for check" or dealStatus === "Ready for Checker's approval") %}

  {% set dealAndFacilityAreReadyForCheck = (facility.status === "Ready for check" and dealStatus === "Ready for Checker's approval") %}
  {% set dealAndFacilityAreSubmitted = (facility.status === "Submitted" and dealStatus === "Submitted") %}
  {% set dealAndFacilityAreAcknowledged = (facility.status === "Acknowledged" and dealStatus === "Acknowledged by UKEF") %}

  {% set dealAndFacilityHaveMatchingStatus = (dealAndFacilityAreReadyForCheck or dealAndFacilityAreSubmitted or dealAndFacilityAreAcknowledged) %}

  {% set onlyPreviewLinkCanBeShown = dealAndFacilityHaveMatchingStatus %}

  {% if dealStatusAllowsIssueFacility or onlyPreviewLinkCanBeShown %}
  
    {% set showFacilityIssuedLink = (facilityCouldBeIssued or facility.issueFacilityDetailsProvided) %}

    {% if showFacilityIssuedLink %}
      
      {% if userIsChecker and not userIsMaker %}
        <a href="/contract/{{ dealId }}/submission-details#{{ facilityName }}-{{ facility._id }}" class="govuk-link" data-cy="{{ facilityName }}-issue-facility-{{ facility._id }}">Facility issued</a>

        {% else %}

        {% set issueFacilityDetailsSubmitted = facility.issueFacilityDetailsSubmitted %}

        {% set makerCannotStartOrEditIssueFacility = ((issueFacilityDetailsSubmitted and dealOrFacilityAreReadyForCheck) or onlyPreviewLinkCanBeShown) %}

        {% if makerCannotStartOrEditIssueFacility %}

          {# TODO: should this be submission details page? #}
          {# <a href="/contract/{{ dealId }}/submission-details#{{ facilityName }}-{{ facility._id }}" class="govuk-link" data-cy="{{ facilityName }}-issue-facility-{{ facility._id }}">Facility issued</a> #}
          <a href="/contract/{{ dealId }}/{{ facilityName }}/{{ facility._id}}/preview" class="govuk-link" data-cy="{{ facilityName }}-issue-facility-{{ facility._id }}">
            {% if facility.issueFacilityDetailsStarted %}
              Facility issued
            {% else %}
              Issue facility
            {% endif %}
          </a>

          {% else %}
          <a href="/contract/{{ dealId }}/{{ facilityName }}/{{ facility._id}}/issue-facility" class="govuk-link" data-cy="{{ facilityName }}-issue-facility-{{ facility._id }}">
            {% if facility.issueFacilityDetailsStarted %}
              Facility issued
            {% else %}
              Issue facility
            {% endif %}
          </a>

        {% endif %}

      {% endif %}

    {% endif %}

    {% elseif params.editable %} 
      <a href="/contract/{{ dealId }}/{{ facilityName }}/{{ facility._id}}/delete" class="govuk-link" data-cy="{{ facilityName }}-delete-{{ facility._id }}" aria-label="Delete facility">Delete</a>
  {% endif %}

{% endmacro %}
