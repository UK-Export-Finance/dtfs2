{% from "govuk/components/skip-link/macro.njk" import govukSkipLink %}
{% from "govuk/components/header/macro.njk" import govukHeader %}
{% from "govuk/components/service-navigation/macro.njk" import govukServiceNavigation %}

{{ govukSkipLink({
  text: "Skip to main content",
  href: "#main-content",
  attributes: {
    'data-cy': 'skip-link'
  }
}) }}

{{ govukHeader({
  homepageUrl: "https://www.gov.uk/",
  attributes: {
    "data-cy": "header"
  }
}) }}

<!-- Roles -->
{% set isUser = user and user.roles.length > 0 %}
{% set isMaker = isUser and user
  .roles
  .includes("maker") %}
{% set isChecker = isUser and user
  .roles
  .includes("checker") %}
{% set isAdmin = isUser and user
  .roles
  .includes("admin") %}
{% set isReadOnly = isUser and user.roles.includes("read-only") %}
{% set isPaymentReportOfficer = isUser and user.roles.includes("payment-report-officer") %}
{% set isDealUser = isMaker or isChecker or isReadOnly or isAdmin %}
{% set isReportUser = isMaker or isChecker or isAdmin %}

<!-- Feature flags -->
{% set isFixedFeeRecordCorrection = isUser and isPaymentReportOfficer and FF_FEE_RECORD_CORRECTION_ENABLED === "true" %}

<!-- Navigation items -->
{% set navigation = [] %}

{% set dashboard = {
    text: "Dashboard",
    href: "/dashboard",
    active: primaryNav == "dashboard",
    attributes: {
      "data-cy": "dashboard-header"
    }
  } %}

{% set report = {
    text: "Reports",
    href: "/reports",
    active: primaryNav == "reports",
    attributes: {
      "data-cy": "reports-header"
    }
  } %}

{% set reportGefUtilisationAndFees = {
    text: "Report GEF utilisation and fees",
    href: "/utilisation-report-upload",
    active: primaryNav == "utilisation_report_upload",
    attributes: {
      "data-cy": "upload-report-header"
    }
  } %}
{% set previousGefReports = {
    text: "Previous GEF reports",
    href: "/previous-reports",
    active: primaryNav == "previous-reports-header",
    attributes: {
      "data-cy": "previous-reports-header"
    }
  } %}
{% set recordCorrectionLog = {
    text: "Record correction log",
    href: "/utilisation-reports/correction-log",
    active: primaryNav == "record-correction-log-header",
    attributes: {
      "data-cy": "record-correction-log-header"
    }
  } %}

{% set users = {
    href: "/admin/users",
    active: primaryNav == "users",
    text: "Users",
        attributes: {
      "data-cy": "users-header"
    }
  } %}

{% set profile = {
    href: "/user/" + user._id,
    text: "Profile",
    active: primaryNav == "profile",
    attributes: {
      "data-cy": "profile-header"
    }
  } %}

{% set logout = {
    href: "/logout",
    text: "Sign out",
    active: false,
    attributes: {
      "data-cy": "logout-header"
    }
  }%}

<!-- 1. Deal users -->
{% if isDealUser %}
  {% set navigation = (navigation.push(dashboard), navigation) %}
{% endif %}

<!-- 2. Report users -->
{% if isReportUser %}
  {% set navigation = (navigation.push(report), navigation) %}
{% endif %}

<!-- 3. PRO -->
{% if isPaymentReportOfficer %}
  {% set navigation = (navigation.push(reportGefUtilisationAndFees, previousGefReports), navigation) %}
{% endif %}

<!-- 4. Fixed fee -->
{% if isFixedFeeRecordCorrection %}
  {% set navigation = (navigation.push(recordCorrectionLog), navigation) %}
{% endif %}

<!-- 5. Admin -->
{% if isAdmin %}
  {% set navigation = (navigation.push(users), navigation) %}
{% endif %}

<!-- 6. All users -->
{% if isUser %}
  {% set navigation = (navigation.push(profile, logout), navigation) %}
{% endif %}

{{ govukServiceNavigation({
  serviceName: "Get a guarantee for export finance",
  serviceUrl: "https://get-a-guarantee-for-export-finance.service.gov.uk/",
  ariaLabel: "Service navigation",
  attributes: {
    "data-cy": "serviceName-header"
  },
  navigation: navigation
}) }}