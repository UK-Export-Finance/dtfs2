{% extends "index.njk" %}
{% import '_macros/confirm-eligibility-nav.njk' as confirmEligibility %}

{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/fieldset/macro.njk" import govukFieldset %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}

{% block pageTitle %}Eligibility Criteria - {{ bankSupplyContractName }}{% endblock %}

{% block content %}

  <script type="text/javascript">
    function onChangeRadioButton(element, shouldShow) {
      window.dtfs.showHideElement(element, shouldShow);
    }
  </script>

    {% if validationErrors.count %}
    {{
      govukErrorSummary({
        titleText: "There is a problem",
        errorList: validationErrors.summary
      })
    }}
    {% endif %}

  {{ confirmEligibility.nav(
    completedStatus = eligibility.completedStatus,
    current = 'eligibilityCriteria',
    contractId = _id
  )}}

  <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-8" />
  
  <form method="POST" autocomplete="off">

    {% for criterion in eligibility.criteria %}
      {% set hasValidationError = validationErrors.errorList[criterion.id] %}

      <div id="criterion-group-{{criterion.id}}" class="govuk-form-group {% if hasValidationError %}govuk-form-group--error{% endif %}" data-cy="eligibility-criteria-item">

        <fieldset class="govuk-fieldset">

          <legend class="govuk-fieldset__legend govuk-fieldset__legend">
            Eligibility criterion {{ criterion.id }}
          </legend>

          <p class="govuk-body govuk-hint">{{ criterion.description }}</p>
          {% if hasValidationError %}
          <span class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> Eligibility criterion {{ criterion.id }} is required
          </span>
          {% endif %}

          <div class="govuk-radios govuk-radios--inline">

            <div class="govuk-radios__item">
              <input  class="govuk-radios__input"
                      id="criterion-{{ criterion.id }}"
                      name="criterion-{{ criterion.id }}"
                      type="radio"
                      value="true"
                      {% if eligibility.status !== "Initial" and criterion.answer %}checked{% endif %}
                      {% if criterion.id == "11" %}onClick="onChangeRadioButton('criterion-group-additional-{{ criterion.id }}', false)"{% endif %}
                      data-cy="criteria-true"
                      data-id="criteria-{{ criterion.id }}-true"
              >
              <label class="govuk-label govuk-radios__label" for="criterion-{{ criterion.id }}">
                True
              </label>
            </div>

            <div class="govuk-radios__item">
              <input  class="govuk-radios__input"
                      id="criterion-{{ criterion.id }}-2"
                      name="criterion-{{ criterion.id }}"
                      type="radio"
                      value="false"
                      {% if eligibility.status !== "Initial" and criterion.answer === false %}checked{% endif %}
                      {% if criterion.id == "11" %}onClick="onChangeRadioButton('criterion-group-additional-{{ criterion.id }}', true)"{% endif %}
                      data-cy="criteria-false"
                      data-id="criteria-{{ criterion.id }}-false"
              >
              <label class="govuk-label govuk-radios__label" for="criterion-{{ criterion.id }}-2">
                False
              </label>
            </div>
          </div>

        </fieldset>

      </div>
      
      {% if criterion.id == "11" %}
        <div id="criterion-group-additional-{{criterion.id}}" {% if criterion.answer != false  %}hidden{% endif %} aria-hidden="{% if criterion.answer != false %}true{% else %}false{% endif %}" data-cy="criteria-11-extra-info">
          
          {% set hasAgentNameValidationError = validationErrors.errorList['agent-name'] %}
          <div id="criterion-group-agent-name" class="govuk-form-group{% if hasAgentNameValidationError %} govuk-form-group--error{% endif %}">

            <div class="govuk-character-count" data-module="govuk-character-count" data-maxlength="150">
              <div class="govuk-form-group">
                <label class="govuk-label" for="agent-name">
                  Agent's corporate name
                </label>
                <span id="agent-name-hint" class="govuk-hint">
                  This should be the legal name of the entity.
                </span>
                <input class="govuk-input govuk-!-width-one-half govuk-js-character-count" id="agent-name" name="agent-name" value="{{eligibility.agentName}}" maxLength="150" aria-describedby="agentName-info agentName-hint" data-cy="agents-name-input" /> 
              </div>

              <span id="agent-name-info" class="govuk-hint govuk-character-count__message" aria-live="polite" data-cy="agents-name-count">
                You can enter up to 150 characters
              </span>

            </div>
          </div>

          {% call govukFieldset({
            classes: "govuk-!-padding-3 box-solid",
            legend: {
              text: "Agent's corporate address",
              classes: "govuk-!-margin-2",
              isPageHeading: false
            }
          }) %}
          
            {{ govukSelect({
                id: "criterion-group-agent-country",
                name: "agent-country",
                label: {
                  text: "Country"
                },
                items: countries,
                errorMessage: validationErrors.errorList['agent-country']
              }) }}
                
            {{ govukInput({
              label: {
                html: 'Address line 1 <span class="govuk-visually-hidden">line 1 of 4</span>'
              },
              classes: "govuk-!-width-one-half",
              id: "criterion-group-agent-address-line-1",
              name: "agent-address-line-1",
              value: eligibility.agentAddress1,
              errorMessage: validationErrors.errorList['agent-address-line-1']
            }) }}

            {{ govukInput({
              label: {
                html: 'Address line 2 (optional) <span class="govuk-visually-hidden">line 2 of 4</span>'
              },
              classes: "govuk-!-width-one-half",
              id: "criterion-group-agent-address-line-2",
              name: "agent-address-line-2",
              value: eligibility.agentAddress2
            }) }}

            {{ govukInput({
              label: {
                html: 'Address line 3 (optional) <span class="govuk-visually-hidden">line 3 of 4</span>'
              },
              classes: "govuk-!-width-one-half",
              id: "criterion-group-agent-address-line-3",
              name: "agent-address-line-3",
              value: eligibility.agentAddress3
            }) }}

            {{ govukInput({
              label: {
                html: 'City/Town (optional) <span class="govuk-visually-hidden">line 4 of 4</span>'
              },
              classes: "govuk-!-width-one-half",
              id: "criterion-group-agent-address-town",
              name: "agent-address-town",
              value: eligibility.agentTown
            }) }}

            {{ govukInput({
              label: {
                text: "Postcode"
              },
              classes: "govuk-input--width-10",
              id: "criterion-group-agent-postcode",
              name: "agent-postcode",
              value: eligibility.agentPostcode,
              errorMessage: validationErrors.errorList['agent-postcode']
            }) }}

          {% endcall %}
        </div>
      {% endif %}

    {% endfor %}

    <input type="submit" class="govuk-button govuk-!-margin-right-1" data-module="govuk-button" value="Next page" data-cy="next-page" />

    <input
      type="submit"
      formaction="/contract/{{ _id }}/eligibility/criteria/save-go-back"
      class="govuk-button govuk-button--secondary"
      data-module="govuk-button"
      value="Save and go back to deal"
    />
    
  </form>

{% endblock %}
